<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Ujian Siswa</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif; /* Using Inter font */
            background-color: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1),
                        inset 0 -2px 4px rgba(255,255,255,0.7);
            margin: 0;
            padding: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header-box {
            background-color: #0066cc;
            padding: 20px 15px;
            color: white;
        }

        .header-box .logo {
            width: 80px;
        }

        .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .judul-ujian {
            color: #0066cc; /* Blue color like header */
            font-size: 22px; /* Same size as SMPN 2 PAJANGAN */
            font-weight: bold;
            margin: 10px 0;
        }

        input, select {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            transform: scale(0.98);
        }

        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confirmModal.show {
            display: flex;
            opacity: 1;
        }

        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
        }

        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }

        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }

        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }

        #confirmModal .modal-content .info-table td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }

        #confirmModal .modal-content .info-table td:last-child {
            text-align: left;
            color: #000;
        }

        #confirmModal .modal-content .button-container {
            text-align: center;
            margin-top: 20px;
        }

        #confirmModal button {
            margin: 5px 5px 0 5px;
            padding: 10px 15px;
            width: auto;
            border-radius: 5px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #btnLanjut {
            background-color: #28a745; /* Green color */
        }

        #btnLanjut:hover {
            background-color: #218838;
        }

        #btnLanjut:active {
            transform: scale(0.98);
        }

        #btnBatal {
            background-color: #dc3545; /* Red color */
        }

        #btnBatal:hover {
            background-color: #c82333;
        }

        #btnBatal:active {
            transform: scale(0.98);
        }

        /* New CSS for checkbox container */
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align to the left */
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px; /* Add some padding from the left edge of the modal content */
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0; /* Adjust margin for spacing */
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none; /* Remove default input shadow */
            display: inline-block; /* Ensure it's inline with text */
        }

        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }

        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px; /* Adjust spacing from checkbox */
            margin-bottom: 10px;
            min-height: 1.2em; /* Ensure space for message */
        }


        @media (max-width: 600px) {
            .container {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                border: none;
                box-shadow: none;
                width: 100%;
            }
            .header-box {
                border-radius: 0;
            }
            #confirmModal .modal-content {
                padding: 20px;
                max-width: 90%;
            }
            #confirmModal .modal-content h4 {
                font-size: 1.5em;
            }
            #confirmModal .modal-content .info-table td {
                font-size: 1em;
            }
            #confirmModal .modal-content .info-table td:first-child {
                width: 90px; /* Adjust label width for mobile */
            }
            .checkbox-container {
                padding-left: 5px; /* Adjust padding for mobile */
            }
        }

        @media (max-width: 400px) {
            .header-box .logo {
                width: 60px;
            }
            .title {
                font-size: 18px;
            }
            .card-body {
                padding: 15px;
            }
            input, select {
                font-size: 14px;
                padding: 8px;
            }
            button {
                font-size: 14px;
                padding: 8px 15px;
            }
            .footer {
                font-size: 10px;
            }
            .checkbox-container {
                font-size: 0.9em; /* Smaller font for mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-box">
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
            <div class="title">SMPN 2 PAJANGAN</div>
        </div>
        <div class="card-body">
            <div class="judul-ujian">UJIAN BERBASIS ONLINE</div>
            <p>Selamat datang</p>
            <p>Silakan login menggunakan token ujian yang Anda miliki</p>

            <div id="locationBlocked" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;">
                AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!
            </div>
            <p class="message" id="message"></p>
            <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center;">Memuat status lokasi...</p>

            <select id="selectKelas" onchange="filterStudentsByClass()" style="margin: 10px auto; display: block; padding: 10px; width: calc(100% - 20px); font-size: 16px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; text-align: center;" disabled>
                <option value="">-- Pilih Kelas --</option>
            </select>

            <select id="selectNamaSiswa" style="margin: 10px auto; display: block; padding: 10px; width: calc(100% - 20px); font-size: 16px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; text-align: center;" disabled>
                <option value="">-- Pilih Nama Siswa --</option>
            </select>

            <input type="text" id="inputToken" placeholder="TOKEN-IDSiswa (Contoh: ABCDE-001)" oninput="formatToken(this)" maxlength="14" style="margin-left: auto; margin-right: auto; text-align: center;" />
            <button id="loginBtn" onclick="cekToken()" disabled style="opacity: 0.6; margin-left: auto; margin-right: auto;">Login</button>
        </div>
        <div class="footer">
            Â© Admin SMPN 2 Pajangan<br>
            <span id="datetime"></span>
        </div>
    </div>

    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p> <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAOBCX8x60pYqxtXmXMz2xc5dwC3HJH5EE",
            authDomain: "ujian-online-berbasis-android.firebaseapp.com",
            databaseURL: "https://ujian-online-berbasis-android-default-rtdb.firebaseio.com",
            projectId: "ujian-online-berbasis-android",
            storageBucket: "ujian-online-berbasis-android.appspot.com",
            messagingSenderId: "923446282537",
            appId: "1:923446282537:web:60d374dde8aca61f6a0f38"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Referensi ke node setlokasi, students, dan exam_access_status di Firebase
        const settingsRef = ref(db, 'setlokasi');
        const studentsRef = ref(db, 'students');
        const tokensRef = ref(db, 'tokens');
        const examAccessStatusRef = ref(db, 'exam_access_status');

        // Variabel kontrol fitur lokasi
        let isLocationEnabled = true; // Default aktif
        let firebaseAllowedRadiusKm = 0.075; // Default radius, akan diperbarui dari Firebase

        // Koordinat pusat lokasi yang diizinkan (tetap statis di sisi siswa)
        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;

        // Elemen DOM
        const locationBlockedDiv = document.getElementById('locationBlocked');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        const inputToken = document.getElementById('inputToken');
        const selectKelas = document.getElementById('selectKelas');
        const selectNamaSiswa = document.getElementById('selectNamaSiswa');
        const confirmCheckbox = document.getElementById('confirmCheckbox'); // Checkbox element
        const modalMessage = document.getElementById('modalMessage'); // Modal message element

        // Variabel untuk menyimpan semua data siswa yang dimuat
        let allStudentsData = [];
        let selectedStudentData = null; // Menyimpan data siswa yang terpilih dari dropdown nama siswa
        let isLocationValid = false; // Melacak validitas lokasi
        let foundTokenGlobal = null; // Variabel global untuk menyimpan data token yang ditemukan untuk modal

        // --- Fungsi Utilitas ---

        /**
         * Menambahkan nol di depan ID siswa agar memiliki 3 digit.
         * @param {string|number} id - ID siswa.
         * @returns {string} ID siswa yang sudah di-padding.
         */
        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        /**
         * Memeriksa apakah perangkat adalah perangkat sentuh.
         * @returns {boolean} True jika perangkat sentuh, false jika tidak.
         */
        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        /**
         * Menghitung jarak antara dua koordinat geografis menggunakan rumus Haversine.
         * @param {number} lat1 - Lintang titik 1.
         * @param {number} lon1 - Bujur titik 1.
         * @param {number} lat2 - Lintang titik 2.
         * @param {number} lon2 - Bujur titik 2.
         * @returns {number} Jarak dalam kilometer.
         */
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Jarak dalam km
            return d;
        }

        /**
         * Mengubah derajat ke radian.
         * @param {number} deg - Sudut dalam derajat.
         * @returns {number} Sudut dalam radian.
         */
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Fungsi Pembaruan UI ---

        /**
         * Memperbarui tanggal dan waktu saat ini yang ditampilkan di footer.
         */
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        /**
         * Memformat input token menjadi huruf besar dan menambahkan tanda hubung setelah 5 karakter.
         * @param {HTMLInputElement} inputElement - Bidang input untuk token.
         */
        window.formatToken = function (inputElement) {
            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); // Hanya izinkan alfanumerik, konversi ke huruf besar
            if (value.length > 5 && value.indexOf('-') === -1) {
                value = value.substring(0, 5) + '-' + value.substring(5);
            }
            inputElement.value = value;
            updateLoginButtonStatus(); // Perbarui status tombol saat input berubah
        };

        /**
         * Memperbarui status aktif/nonaktif dan opasitas tombol Login
         * berdasarkan validitas lokasi dan kelengkapan bidang input.
         */
        function updateLoginButtonStatus() {
            // Periksa apakah validasi lokasi telah lolos (jika fitur lokasi diaktifkan dan ini adalah perangkat sentuh)
            const isLocationCheckPassed = (isLocationEnabled && isTouchDevice()) ? isLocationValid : true;

            // Periksa apakah semua input dan dropdown yang diperlukan telah diisi
            const isAllInputsFilled = selectKelas.value !== "" &&
                                      selectNamaSiswa.value !== "" &&
                                      inputToken.value.trim() !== "";

            // Aktifkan tombol login hanya jika lokasi valid (atau fitur dimatikan) DAN semua input terisi
            if (isLocationCheckPassed && isAllInputsFilled) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = 1;
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
            }
        }

        /**
         * Menyembunyikan modal konfirmasi dan mengatur ulang UI.
         */
        window.tutupModal = function () {
            confirmModal.classList.remove('show');
            message.textContent = ""; // Hapus pesan sebelumnya
            modalMessage.textContent = ""; // Clear modal message
            confirmCheckbox.checked = false; // Uncheck the checkbox
            updateLoginButtonStatus(); // Pastikan status tombol login benar setelah menutup modal
        };

        // --- Penanganan Lokasi ---

        /**
         * Memeriksa lokasi pengguna saat ini terhadap koordinat dan radius yang diizinkan.
         * Memperbarui elemen UI berdasarkan validitas lokasi.
         * @param {number} latitude - Lintang lokasi pengguna saat ini.
         * @param {number} longitude - Bujur lokasi pengguna saat ini.
         */
        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            if (distance <= firebaseAllowedRadiusKm) {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.textContent = "Lokasi valid."; // Hapus pesan status lokasi
                locationStatus.style.color = "green";
            } else {
                locationBlockedDiv.style.display = 'block';
                locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
                isLocationValid = false;
                locationStatus.textContent = `Anda berada ${distance.toFixed(2)} km dari lokasi yang diizinkan.`;
                locationStatus.style.color = "red";
            }
            updateLoginButtonStatus(); // Perbarui status tombol login setelah pemeriksaan lokasi
        }

        /**
         * Handler untuk pengambilan geolokasi yang berhasil.
         * @param {GeolocationPosition} position - Objek posisi geolokasi.
         */
        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        /**
         * Handler untuk kesalahan geolokasi.
         * @param {GeolocationPositionError} error - Objek kesalahan geolokasi.
         */
        function handleLocationError(error) {
            // Log objek error lengkap untuk debugging yang lebih baik
            console.error("Error getting location:", error);

            locationBlockedDiv.style.display = 'block';
            locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
            message.style.color = "orange";

            // Pesan default untuk kesalahan yang tidak diketahui
            let errorMessage = "Terjadi kesalahan yang tidak diketahui dengan layanan lokasi.";

            // Periksa apakah error.code ada dan berupa angka, lalu gunakan switch
            if (error && typeof error.code === 'number') {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Lokasi belum diaktifkan, mohon aktifkan lokasi di pengaturan perangkat Anda.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Informasi lokasi tidak tersedia.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Waktu permintaan lokasi habis.";
                        break;
                    // Tidak perlu case default di sini karena errorMessage sudah diatur
                }
            } else if (error && error.message) {
                // Fallback untuk kesalahan yang mungkin memiliki pesan tetapi tidak ada kode
                errorMessage = `Terjadi kesalahan: ${error.message}`;
            }

            message.textContent = errorMessage; // Selalu perbarui konten pesan
            isLocationValid = false; // Lokasi tidak valid jika ada error
            updateLoginButtonStatus(); // Pastikan tombol login dinonaktifkan
        }

        /**
         * Memulai pemantauan geolokasi jika lokasi diaktifkan dan ini adalah perangkat sentuh.
         * Jika tidak, dianggap lokasi valid.
         */
        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Mencari lokasi Anda...';
                if (navigator.geolocation) {
                    // Gunakan watchPosition untuk memantau lokasi secara terus-menerus
                    navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    locationBlockedDiv.style.display = 'block';
                    locationBlockedDiv.textContent = 'Geolocation tidak didukung oleh perangkat ini.';
                    message.style.color = "red";
                    isLocationValid = false;
                    updateLoginButtonStatus();
                }
            } else {
                // Jika bukan perangkat sentuh, atau jika lokasi dinonaktifkan di panel admin, langsung anggap valid
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.style.display = 'none'; // Sembunyikan status lokasi jika tidak memeriksa
                updateLoginButtonStatus(); // Aktifkan tombol login
            }
        }

        // --- Pemuatan dan Pemfilteran Data ---

        /**
         * Memuat semua data siswa dari Firebase dan mengisi dropdown kelas.
         * Juga memanggil getLocation() setelah data dimuat.
         */
        async function loadStudentsAndPopulateClassDropdown() {
            selectKelas.disabled = true; // Nonaktifkan sampai dimuat
            selectNamaSiswa.disabled = true; // Nonaktifkan sampai kelas dipilih
            message.innerHTML = `Memuat data siswa... <span class="spinner"></span>`;
            try {
                const snapshot = await get(studentsRef);
                if (snapshot.exists()) {
                    allStudentsData = Object.values(snapshot.val()); // Ambil semua siswa sebagai array
                    const classes = new Set();
                    allStudentsData.forEach(student => {
                        if (student.class) {
                            classes.add(student.class);
                        }
                    });

                    selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>'; // Reset
                    // Urutkan kelas secara alfanumerik (misal 7A sebelum 8A)
                    Array.from(classes).sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/));
                        const numB = parseInt(b.match(/\d+/));
                        if (numA && numB && numA !== numB) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    }).forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        selectKelas.appendChild(option);
                    });
                    selectKelas.disabled = false;
                    message.textContent = ""; // Hapus pesan loading
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan di database.";
                }
            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                message.style.color = "red";
                message.textContent = "Gagal memuat data siswa dari database.";
            } finally {
                // Setelah siswa dimuat, lanjutkan dengan pemeriksaan lokasi
                getLocation();
            }
        }

        /**
         * Memfilter dropdown nama siswa berdasarkan kelas yang dipilih.
         */
        window.filterStudentsByClass = function() {
            const selectedClass = selectKelas.value;
            selectNamaSiswa.innerHTML = '<option value="">-- Pilih Nama Siswa --</option>'; // Reset
            selectNamaSiswa.disabled = true;
            selectedStudentData = null; // Reset siswa yang dipilih

            if (selectedClass) {
                const filteredStudents = allStudentsData.filter(student => student.class === selectedClass);
                filteredStudents.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id; // Gunakan ID siswa sebagai value
                    option.textContent = student.name;
                    selectNamaSiswa.appendChild(option);
                });
                selectNamaSiswa.disabled = false;
            }
            updateLoginButtonStatus(); // Perbarui status tombol login setelah pemfilteran
        };

        // --- Logika Login dan Modal ---

        /**
         * Menangani klik tombol "Lanjutkan" di modal konfirmasi.
         * Mencatat akses ujian dan mengarahkan ke Google Form.
         * @param {string} userEnteredTokenId - Nilai TOKEN-IDSiswa yang diinput oleh pengguna.
         */
        async function handleLanjutClick(userEnteredTokenId) {
            // Check if the confirmation checkbox is checked
            if (!confirmCheckbox.checked) {
                modalMessage.style.display = 'block';
                modalMessage.textContent = "Anda harus mencentang 'Data di atas sudah benar' untuk melanjutkan.";
                return; // Stop the function if checkbox is not checked
            } else {
                modalMessage.style.display = 'none'; // Hide message if checkbox is checked
            }

            message.innerHTML = `Mencatat akses ujian... <span class="spinner"></span>`;
            confirmModal.classList.remove('show'); // Hide modal immediately

            // Pastikan foundTokenGlobal dan selectedStudentData tersedia
            if (!foundTokenGlobal || !selectedStudentData) {
                console.error("Error: Data token atau data siswa tidak ada untuk pengalihan.");
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat menyiapkan tautan ujian. Coba lagi.";
                updateLoginButtonStatus(); // Aktifkan kembali tombol login
                return;
            }

            const examAccessRef = child(examAccessStatusRef, `${foundTokenGlobal.key}/${selectedStudentData.id}`);

            try {
                await runTransaction(examAccessRef, (currentAccess) => {
                    const nowAccess = Date.now();
                    const SPAM_THRESHOLD_MS = 5000; // Ambang batas 5 detik untuk dihitung sebagai akses baru

                    if (currentAccess === null) {
                        return {
                            firstAccessTime: nowAccess,
                            lastAccessTime: nowAccess,
                            accessCount: 1
                        };
                    } else {
                        if (nowAccess - (currentAccess.lastAccessTime || 0) > SPAM_THRESHOLD_MS) {
                            currentAccess.accessCount = (currentAccess.accessCount || 0) + 1;
                            currentAccess.lastAccessTime = nowAccess;
                        } else {
                            currentAccess.lastAccessTime = nowAccess; // Tetap perbarui waktu akses terakhir untuk klik spam
                        }
                        return currentAccess;
                    }
                });
                console.log(`Akses ke token ${foundTokenGlobal.key} oleh siswa ${selectedStudentData.id} berhasil dicatat.`);

                // Buat URL Google Forms dengan ID entri dinamis
                // PENTING: Ganti ID placeholder di bawah ini dengan ID entri Google Forms Anda yang sebenarnya!
                const tokenEntryId = foundTokenGlobal.tokenEntryId || 'YOUR_TOKEN_ENTRY_ID';
                const nameEntryId = foundTokenGlobal.nameEntryId || 'YOUR_NAME_ENTRY_ID';
                const classEntryId = foundTokenGlobal.classEntryId || 'YOUR_CLASS_ENTRY_ID';

                const googleFormUrl = `${foundTokenGlobal.url}?usp=pp_url` +
                                        `&entry.${tokenEntryId}=${encodeURIComponent(userEnteredTokenId)}` +
                                        `&entry.${nameEntryId}=${encodeURIComponent(selectedStudentData.name)}` +
                                        `&entry.${classEntryId}=${encodeURIComponent(selectedStudentData.class)}`;

                console.log("Mengarahkan ke Google Form URL:", googleFormUrl);
                window.open(googleFormUrl, '_blank'); // Buka di tab baru

            } catch (error) {
                console.error("Gagal mencatat akses token atau mengarahkan:", error);
                message.style.color = "orange";
                message.textContent = "Gagal mencatat akses ujian, namun Anda akan tetap dialihkan.";
                // Meskipun pencatatan gagal, tetap arahkan ulang sebagai fallback
                setTimeout(() => {
                    const tokenEntryId = foundTokenGlobal.tokenEntryId || 'YOUR_TOKEN_ENTRY_ID';
                    const nameEntryId = foundTokenGlobal.nameEntryId || 'YOUR_NAME_ENTRY_ID';
                    const classEntryId = foundTokenGlobal.classEntryId || 'YOUR_CLASS_ENTRY_ID';

                    const googleFormUrl = `${foundTokenGlobal.url}?usp=pp_url` +
                                            `&entry.${tokenEntryId}=${encodeURIComponent(userEnteredTokenId)}` +
                                            `&entry.${nameEntryId}=${encodeURIComponent(selectedStudentData.name)}` +
                                            `&entry.${classEntryId}=${encodeURIComponent(selectedStudentData.class)}`;
                    console.log("Mengarahkan ke Google Form URL (fallback):", googleFormUrl);
                    window.open(googleFormUrl, '_blank'); // Buka di tab baru sebagai fallback
                }, 1500); // Beri waktu pengguna untuk membaca pesan
            } finally {
                updateLoginButtonStatus(); // Pastikan tombol login diaktifkan kembali untuk percobaan berikutnya
            }
        }

        /**
         * Fungsi utama untuk memeriksa token yang dimasukkan dan detail siswa.
         * Menampilkan modal konfirmasi jika validasi berhasil.
         */
        window.cekToken = async function () {
            const selectedClass = selectKelas.value;
            const selectedStudentId = selectNamaSiswa.value;
            const fullInputToken = inputToken.value.trim(); // Ambil input lengkap di sini

            // Validasi input dasar
            if (!selectedClass || !selectedStudentId || !fullInputToken) {
                message.style.color = "red";
                message.textContent = "Harap lengkapi semua pilihan (Kelas, Nama Siswa, dan Token).";
                updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                return;
            }

            // Pisahkan token dan ID siswa dari string input
            const parts = fullInputToken.split('-');
            if (parts.length !== 2) {
                message.style.color = "red";
                message.textContent = "Format Token-ID Siswa salah. Gunakan TOKEN-IDSiswa (Contoh: ABCDE-001).";
                updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                return;
            }

            const inputTokenValue = parts[0].trim();
            const inputStudentIdFromToken = padStudentId(parts[1].trim());

            // Validasi tambahan: ID Siswa dari token harus cocok dengan yang dipilih dari dropdown
            if (inputStudentIdFromToken !== selectedStudentId) {
                message.style.color = "red";
                message.textContent = "ID Siswa pada token tidak cocok dengan nama siswa yang dipilih.";
                updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                return;
            }

            // Nonaktifkan tombol login dan tampilkan spinner loading
            loginBtn.disabled = true;
            loginBtn.style.opacity = 0.6;
            message.style.color = "black";
            message.innerHTML = `Memproses data... <span class="spinner"></span>`;

            try {
                const tokensSnapshot = await get(tokensRef);

                let foundToken = null;

                // 1. Cari token
                tokensSnapshot.forEach(child => {
                    const data = child.val();
                    if (data.token === inputTokenValue.toUpperCase()) {
                        foundToken = { ...data, key: child.key };
                        return true; // Hentikan loop
                    }
                });

                if (!foundToken) {
                    message.style.color = "red";
                    message.textContent = "Token ujian tidak ditemukan!";
                    updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                    return;
                }

                // Simpan token yang ditemukan secara global untuk tombol "Lanjutkan" modal
                foundTokenGlobal = foundToken;

                // Periksa validitas token (aktif, force-aktif, kadaluarsa)
                const now = new Date();
                const startTime = new Date(foundToken.startTime);
                const endTime = new Date(foundToken.endTime);
                let tokenStatus = ''; // 'valid', 'expired', 'inactive'

                if (foundToken.isForceActive === true) {
                    tokenStatus = 'valid';
                } else if (foundToken.isActive === true) {
                    if (now >= startTime && now <= endTime) {
                        tokenStatus = 'valid';
                    } else {
                        tokenStatus = 'expired'; // Token aktif tapi di luar jendela waktu
                    }
                } else {
                    tokenStatus = 'inactive'; // Token tidak aktif dan tidak force-aktif
                }

                if (tokenStatus !== 'valid') {
                    message.style.color = "red";
                    if (tokenStatus === 'expired') {
                        message.textContent = "Token belum aktif atau sudah kadaluarsa.";
                    } else { // 'inactive'
                        message.textContent = "Token saat ini tidak aktif.";
                    }
                    updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                    return;
                }

                // Validasi: kelas yang dipilih dari dropdown harus cocok dengan kelas token
                const studentClassNumericMatch = selectedStudentData.class.match(/^\d+/); // Ambil angka saja (misal 7 dari 7A)
                const studentClassNumeric = studentClassNumericMatch ? studentClassNumericMatch[0] : null;

                // Pastikan foundToken.kelas juga angka (misal '7')
                if (!studentClassNumeric || String(studentClassNumeric) !== String(foundToken.kelas)) {
                    message.style.color = "red";
                    message.textContent = `Siswa dari kelas ${selectedStudentData.class} tidak dapat mengakses token untuk kelas ${foundToken.kelas}.`;
                    updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
                    return;
                }

                // Semua validasi berhasil, tampilkan modal konfirmasi
                document.getElementById("modalIdSiswa").textContent = selectedStudentData.id || "-";
                document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name || "-";
                document.getElementById("modalKelas").textContent = selectedStudentData.class || "-"; // Mengambil kelas lengkap dari data siswa
                document.getElementById("modalMapel").textContent = foundToken.subject || "-";

                // Reset checkbox dan pesan modal setiap kali modal dibuka
                confirmCheckbox.checked = false;
                modalMessage.style.display = 'none';
                modalMessage.textContent = '';


                confirmModal.classList.add('show');
                message.textContent = ""; // Hapus pesan saat modal ditampilkan

                // Set the "Lanjutkan" button to record access and redirect
                // IMPORTANT: Pass the 'fullInputToken' (e.g., "ABCDE-001") to handleLanjutClick
                document.getElementById("btnLanjut").onclick = () => handleLanjutClick(fullInputToken);

            } catch (err) {
                console.error(err);
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan, silakan coba lagi.";
                updateLoginButtonStatus(); // Pastikan tombol diaktifkan setelah menampilkan error
            }
        };

        // --- Pengaturan Awal saat Konten DOM Dimuat ---
        document.addEventListener('DOMContentLoaded', () => {
            // Mencegah menu konteks klik kanan
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
            });

            // Atur event listener
            inputToken.addEventListener('input', window.formatToken);
            inputToken.addEventListener('input', updateLoginButtonStatus);
            selectKelas.addEventListener('change', window.filterStudentsByClass);
            selectKelas.addEventListener('change', updateLoginButtonStatus);
            selectNamaSiswa.addEventListener('change', function() {
                const studentId = this.value;
                selectedStudentData = allStudentsData.find(student => student.id === studentId);
                updateLoginButtonStatus();
            });

            // Panggilan awal untuk memperbarui tanggal dan waktu
            updateDateTime();
            // Perbarui tanggal dan waktu setiap detik
            setInterval(updateDateTime, 1000);

            // Muat pengaturan dan data siswa, lalu mulai pemeriksaan lokasi
            loadSettingsAndStudents();
            updateLoginButtonStatus(); // Pemeriksaan awal status tombol
        });

        /**
         * Memuat pengaturan Firebase (lokasi diaktifkan, radius) dan kemudian data siswa.
         * Memulai pemeriksaan lokasi setelah data dimuat.
         */
        async function loadSettingsAndStudents() {
            locationStatus.style.display = 'block';
            locationStatus.textContent = 'Memuat status lokasi dan data siswa...';

            try {
                const settingsSnapshot = await get(settingsRef);
                if (settingsSnapshot.exists()) {
                    const settings = settingsSnapshot.val();
                    isLocationEnabled = settings.isLocationEnabled !== undefined ? settings.isLocationEnabled : true;
                    firebaseAllowedRadiusKm = settings.allowedRadiusKm !== undefined ? settings.allowedRadiusKm : 0.075;
                    console.log("Location Status from Firebase:", isLocationEnabled);
                    console.log("Radius from Firebase:", firebaseAllowedRadiusKm);
                } else {
                    console.log("Tidak dapat mengambil pengaturan lokasi dari Firebase, menggunakan default.");
                }
            } catch (error) {
                console.error("Gagal mengambil pengaturan lokasi dari Firebase:", error);
            }

            // Sekarang muat siswa
            await loadStudentsAndPopulateClassDropdown(); // Fungsi ini sudah memanggil getLocation() di akhirnya
            locationStatus.textContent = ''; // Hapus pesan loading untuk status lokasi
        }
    </script>
</body>
</html>
