<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Ujian Siswa</title>
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif; /* Menggunakan font Inter */
            background-color: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1),
                        inset 0 -2px 4px rgba(255,255,255,0.7);
            margin: 0;
            padding: 0; /* Hapus padding body agar iframe bisa fullscreen */
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow: hidden; /* Mencegah scroll body saat overlay aktif */
        }

        .container {
            max-width: 400px;
            width: 90%;
            margin: 20px auto;
            border: 1px solid #ddd;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            flex-shrink: 0; /* Mencegah container login menyusut */
            opacity: 1; /* Initial state for transition */
            transition: opacity 0.5s ease-in-out; /* Smooth transition */
        }

        .header-box {
            background-color: #0066cc;
            padding: 20px 15px;
            color: white;
        }

        .header-box .logo {
            width: 80px;
        }

        .title {
            font-size: 22px;
            font-weight: bold;
            margin-top: 10px;
            color: white;
        }

        .card-body {
            padding: 20px;
        }

        .judul-ujian {
            color: #0066cc; /* Warna biru seperti header */
            font-size: 22px; /* Ukuran sama dengan SMPN 2 PAJANGAN */
            font-weight: bold;
            margin: 10px 0;
        }

        input {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin: 10px auto;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Transition for input feedback */
        }

        /* Custom dropdown styles */
        .custom-dropdown-container {
            position: relative;
            width: calc(100% - 20px);
            margin: 10px auto;
            display: block;
        }

        .custom-dropdown-display {
            padding: 10px;
            width: 100%;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 40px; /* Ensure consistent height */
            color: #555; /* Placeholder-like color */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-dropdown-display.selected {
            color: #000; /* Text color when an item is selected */
        }

        .custom-dropdown-display.disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }

        .custom-dropdown-display::after {
            content: 'â–¼'; /* Dropdown arrow */
            position: absolute;
            right: 15px;
            font-size: 0.8em;
            color: #888;
        }

        /* Input validation feedback styles */
        input.is-valid {
            border-color: #28a745; /* Green */
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        input.is-invalid {
            border-color: #dc3545; /* Red */
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 10px auto;
            display: block;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Gaya khusus untuk tombol Batal */
        #btnBatal {
            background-color: #dc3545; /* Merah */
        }

        #btnBatal:hover {
            background-color: #c82333; /* Merah lebih gelap saat hover */
        }

        .message {
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 30px;
            text-align: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid black; /* Perbaikan: 3px bukan 33px */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            padding-bottom: 10px;
        }

        /* Modal styles for custom dropdowns */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .custom-modal.show {
            display: flex;
            opacity: 1;
        }

        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-height: 80vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling */
            display: flex;
            flex-direction: column;
        }

        .custom-modal-content h4 {
            font-size: 1.5em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0; /* Prevent title from shrinking */
        }

        .custom-modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow list to take available space */
        }

        .custom-modal-list li {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            text-align: left;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }

        .custom-modal-list li:last-child {
            border-bottom: none;
        }

        .custom-modal-list li:hover {
            background-color: #f0f0f0;
        }

        /* Existing modal styles (confirmModal) */
        #confirmModal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        #confirmModal.show {
            display: flex;
            opacity: 1;
        }

        #confirmModal .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 380px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        #confirmModal .modal-content h4 {
            font-size: 1.8em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 15px;
            text-align: center;
        }

        #confirmModal .modal-content .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        #confirmModal .modal-content .info-table tr {
            border-bottom: 1px solid #eee;
        }

        #confirmModal .modal-content .info-table tr:last-child {
            border-bottom: none;
        }

        #confirmModal .modal-content .info-table td {
            padding: 8px 0;
            font-size: 1.1em;
        }

        #confirmModal .modal-content .info-table td:first-child {
            font-weight: bold;
            color: #333;
            width: 120px;
            padding-right: 10px;
        }

        #confirmModal .modal-content .info-table td:last-child {
            text-align: left;
            color: #000;
        }

        /* Checkbox for confirmation */
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align to the left */
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            color: #333;
            padding-left: 10px; /* Add some padding from the left edge of the modal content */
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0; /* Adjust margin for spacing */
            cursor: pointer;
            vertical-align: middle;
            box-shadow: none; /* Remove default input shadow */
            display: inline-block; /* Ensure it's inline with text */
        }

        .checkbox-container label {
            cursor: pointer;
            vertical-align: middle;
        }

        #modalMessage {
            color: red;
            font-size: 0.9em;
            text-align: center;
            margin-top: -10px; /* Adjust spacing from checkbox */
            margin-bottom: 10px;
            min-height: 1.2em; /* Ensure space for message */
        }

        /* Styles for Exam Container and Iframe */
        #examContainer {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            background-color: #f0f0f0; /* Background for entire exam view */
            z-index: 500; /* Below overlay, above login */
            opacity: 0; /* Initial state for transition */
            transition: opacity 0.5s ease-in-out; /* Smooth transition */
        }

        #countdownDisplay {
            background-color: #0066cc;
            color: white;
            padding: 10px;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        #examIframe {
            flex-grow: 1; /* Take all available vertical space */
            width: 100%;
            border: none; /* No borders */
            margin: 0;
            padding: 0;
            display: block; /* Ensure it behaves as a block element */
            transition: filter 0.3s ease; /* Smooth transition for blur/grayscale */
        }
        /* Ensure iframe is visible even when pointer-events are none for overlays */
        #examIframe.blurred {
            filter: grayscale(100%) blur(5px);
            pointer-events: none; /* Disable interaction with iframe */
        }

        /* Styles for Fullscreen Overlay (Initial Instructions) */
        #fullscreenOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8); /* Semi-transparent black background */
            z-index: 9999; /* On top of everything */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scrolling on overlay */
            opacity: 0; /* Initial state for transition */
            transition: opacity 0.3s ease-in-out; /* Smooth transition */
        }
        #fullscreenOverlay.show {
            display: flex;
            opacity: 1;
        }

        .overlay-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px; /* Max width for content */
            width: 90%; /* Responsive width */
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            text-align: center; /* Center text by default */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally */
        }

        .overlay-title {
            font-size: 2em;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 20px;
            text-align: center;
        }

        .overlay-instructions {
            list-style: none; /* Remove default list bullets */
            padding: 0;
            margin: 0 0 20px 0;
            width: 100%; /* Ensure list takes full width for alignment */
            text-align: left; /* Align list items text to left */
            counter-reset: instruction-counter; /* Reset counter for numbered list */
        }

        .overlay-instructions li {
            font-size: 1.1em;
            margin-bottom: 10px;
            position: relative;
            padding-left: 25px; /* Space for custom bullet */
            counter-increment: instruction-counter; /* Increment counter on each list item */
        }

        .overlay-instructions li:before {
            content: counter(instruction-counter) "."; /* Add number before item */
            position: absolute;
            left: 0;
            font-weight: bold;
            color: #0066cc; /* Color for numbers */
        }

        .overlay-instructions strong {
            font-weight: bold; /* Ensure bold text is strong */
        }

        .overlay-button {
            padding: 12px 25px;
            font-size: 1.2em;
            background-color: #28a745; /* Green color */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: auto; /* Allow button to size based on content */
        }

        .overlay-button:hover {
            background-color: #218838;
        }

        .overlay-button:active {
            transform: scale(0.98);
        }

        /* NEW: Warning Overlay (5 minutes left) - UPDATED STYLES for transparency */
        #warningOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0); /* Fully transparent background */
            z-index: 10; /* Changed z-index to layer correctly within examContainer */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scrolling on overlay */
            pointer-events: none; /* Allow interaction with the content box */
            opacity: 0; /* Initial state for transition */
            transition: opacity 0.3s ease-in-out; /* Smooth transition */
        }
        #warningOverlay.show {
            display: flex;
            opacity: 1;
        }

        .warning-content-box { /* New class for the content box */
            background: rgba(255, 255, 255, 0.03); /* White with 3% opacity */
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: none; /* No shadow for very transparent box */
            text-align: center;
            box-sizing: border-box;
            pointer-events: none; /* Ensure content box is not interactive */
        }

        #warningCountdown {
            font-size: 4em; /* Large font for countdown */
            font-weight: bold;
            color: red; /* Red color for countdown */
            text-shadow: 0 0 10px rgba(255,0,0,0.5);
            margin-bottom: 10px;
            pointer-events: none; /* Still allow clicks to pass through this specific element */
            animation: blink-smooth 1.5s infinite alternate; /* Smooth blinking effect */
        }

        @keyframes blink-smooth {
            0% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        #warningMessage {
            font-size: 1.5em; /* Adjust font size as needed */
            color: black; /* Black color for the message */
            font-weight: bold;
            pointer-events: none; /* Still allow clicks to pass through this specific element */
        }

        /* NEW: Locked Overlay (Time's Up) */
        #lockedOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9); /* Opaque background */
            z-index: 20; /* Changed z-index to layer correctly within examContainer */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto; /* Allow interaction */
            opacity: 0; /* Initial state for transition */
            transition: opacity 0.3s ease-in-out; /* Smooth transition */
        }
        #lockedOverlay.show {
            display: flex;
            opacity: 1;
        }

        .locked-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }

        #lockedTitle {
            font-size: 2.5em;
            font-weight: bold;
            color: red;
            margin-bottom: 15px;
        }

        #lockedMessage {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }

        #passwordInput {
            padding: 10px;
            width: calc(100% - 20px);
            font-size: 16px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: center;
        }

        #unlockButton {
            padding: 12px 25px;
            font-size: 1.2em;
            background-color: #007bff; /* Blue color */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #unlockButton:hover {
            background-color: #0056b3;
        }

        #unlockButton:active {
            transform: scale(0.98);
        }

        #unlockErrorMessage {
            color: red;
            font-size: 0.9em;
            margin-top: 10px;
            min-height: 1.2em;
        }

        /* NEW: Styles for Submission Confirmation Overlay (Updated to match Locked Overlay) */
        #submissionConfirmationOverlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9); /* Dark, semi-transparent background, matching lockedOverlay */
            z-index: 10001; /* Higher than other overlays */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scrolling on overlay */
            pointer-events: auto; /* Allow interaction */
            opacity: 0; /* Initial state for transition */
            transition: opacity 0.3s ease-in-out; /* Smooth transition */
        }
        #submissionConfirmationOverlay.show {
            display: flex;
            opacity: 1;
        }

        .submission-content { /* New class for the content box */
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px; /* Matching locked-content */
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5); /* Matching locked-content */
            text-align: center;
            box-sizing: border-box;
        }

        #submissionConfirmationOverlay h1 {
            font-size: 2.5em; /* Matching lockedTitle */
            margin-bottom: 15px; /* Matching lockedTitle */
            font-weight: bold;
            color: #4CAF50; /* Green color for success */
        }

        #submissionConfirmationOverlay p {
            font-size: 1.1em; /* Matching lockedMessage */
            color: #333; /* Matching lockedMessage */
            margin-bottom: 20px; /* Matching lockedMessage */
        }

        #submissionConfirmationOverlay button {
            padding: 12px 25px; /* Matching unlockButton */
            font-size: 1.2em; /* Matching unlockButton */
            border: none;
            border-radius: 8px;
            background-color: #4CAF50; /* Green button for success */
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Matching unlockButton */
        }

        #submissionConfirmationOverlay button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        #submissionConfirmationOverlay button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0,128,0,0.4);
        }

        /* NEW: Fullscreen Exit Warning Overlay */
        #fullscreenExitWarningOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.95); /* Hampir sepenuhnya gelap */
            z-index: 30; /* Changed z-index to layer correctly within examContainer */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            flex-direction: column; /* Untuk menempatkan tombol di bawah pesan */
        }
        #fullscreenExitWarningOverlay.show {
            display: flex;
            opacity: 1;
        }
        .exit-warning-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }
        .exit-warning-content h2 {
            font-size: 2.2em;
            color: #dc3545; /* Merah untuk peringatan */
            margin-bottom: 15px;
        }
        .exit-warning-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }
        .exit-warning-button {
            padding: 12px 25px;
            font-size: 1.2em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .exit-warning-button:hover {
            background-color: #0056b3;
        }

        /* NEW: CSS for preventing text selection globally on the main page */
        /* Will be toggled when entering/exiting exam */
        .no-select {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Safari */
            -khtml-user-select: none;    /* Konqueror HTML */
            -moz-user-select: none;      /* Old versions of Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;           /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
        }

        /* NEW: Refresh Button */
        #refreshPageBtn {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 35;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: none; /* Hidden by default, only show during exam */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #refreshPageBtn:hover {
            background-color: #0056b3;
        }

        /* NEW: Refresh Warning Overlay */
        #refreshWarningOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10002; /* Higher than other overlays */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            flex-direction: column;
        }
        #refreshWarningOverlay.show {
            display: flex;
            opacity: 1;
        }
        .refresh-warning-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            text-align: center;
            box-sizing: border-box;
        }
        .refresh-warning-content h2 {
            font-size: 2.2em;
            color: #ffc107; /* Orange for warning */
            margin-bottom: 15px;
        }
        .refresh-warning-content p {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 20px;
        }
        .refresh-warning-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            width: 100%;
        }
        .refresh-warning-buttons button {
            flex: 1;
            padding: 12px 15px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: auto; /* Override default 100% width */
        }
        #continueRefreshBtn {
            background-color: #dc3545; /* Red for destructive action */
            color: white;
        }
        #continueRefreshBtn:hover {
            background-color: #c82333;
        }
        #cancelRefreshBtn {
            background-color: #6c757d; /* Gray for cancel */
            color: white;
        }
        #cancelRefreshBtn:hover {
            background-color: #5a6268;
        }


        @media (max-width: 600px) {
            .container {
                margin-top: 40px;
                margin-bottom: 40px;
                border-radius: 0;
                border: none;
                box-shadow: none;
                width: 100%;
            }
            .header-box {
                border-radius: 0;
            }
            #confirmModal .modal-content {
                padding: 20px;
                max-width: 90%;
            }
            #confirmModal .modal-content h4 {
                font-size: 1.5em;
            }
            #confirmModal .modal-content .info-table td {
                font-size: 1em;
            }
            #confirmModal .modal-content .info-table td:first-child {
                width: 90px; /* Adjust label width for mobile */
            }
            .checkbox-container {
                padding-left: 5px; /* Adjust padding for mobile */
            }
            .overlay-content {
                padding: 20px;
                width: 95%;
            }
            .overlay-title {
                font-size: 1.5em;
            }
            .overlay-instructions li {
                font-size: 1em;
                padding-left: 20px;
            }
            .overlay-button {
                font-size: 1em;
                padding: 10px 20px;
            }
            /* Updated media queries for warning overlay */
            #warningCountdown {
                font-size: 3em;
            }
            #warningMessage {
                font-size: 1.2em;
            }
            .warning-content-box {
                padding: 20px;
                max-width: 90%;
            }
            #lockedTitle {
                font-size: 2em;
            }
            #lockedMessage {
                font-size: 1em;
            }
            #passwordInput {
                font-size: 14px;
            }
            #unlockButton {
                font-size: 1em;
                padding: 10px 20px;
            }
            /* Updated media queries for submission overlay */
            #submissionConfirmationOverlay h1 {
                font-size: 2em; /* Smaller for mobile */
            }
            #submissionConfirmationOverlay p {
                font-size: 1.2em; /* Smaller for mobile */
            }
            #submissionConfirmationOverlay button {
                font-size: 1em;
                padding: 12px 25px;
            }
            .submission-content {
                padding: 20px;
                max-width: 90%;
            }
            /* Media queries for new overlays */
            .exit-warning-content {
                padding: 20px;
                max-width: 90%;
            }
            .exit-warning-content h2 {
                font-size: 1.8em;
            }
            .exit-warning-content p {
                font-size: 1em;
            }
            .exit-warning-button {
                font-size: 1em;
                padding: 10px 20px;
            }
            #refreshPageBtn {
                font-size: 0.8em;
                padding: 6px 12px;
            }
            /* Refresh warning overlay for mobile */
            .refresh-warning-content {
                padding: 20px;
                max-width: 90%;
            }
            .refresh-warning-content h2 {
                font-size: 1.8em;
            }
            .refresh-warning-content p {
                font-size: 1em;
            }
            .refresh-warning-buttons button {
                font-size: 0.9em;
                padding: 10px 12px;
            }
            /* Custom modal for mobile */
            .custom-modal-content {
                padding: 15px;
                width: 95%;
                max-height: 90vh; /* More height for mobile */
            }
            .custom-modal-content h4 {
                font-size: 1.2em;
            }
            .custom-modal-list li {
                padding: 10px 12px;
                font-size: 1em;
            }
        }

        @media (max-width: 400px) {
            .header-box .logo {
                width: 60px;
            }
            .title {
                font-size: 18px;
            }
            .card-body {
                padding: 15px;
            }
            input {
                font-size: 14px;
                padding: 8px;
            }
            button {
                font-size: 14px;
                padding: 8px 15px;
            }
            .footer {
                font-size: 10px;
            }
            .checkbox-container {
                font-size: 0.9em; /* Smaller font for mobile */
            }
            .custom-dropdown-display {
                font-size: 14px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="loginContainer" class="container">
        <div class="header-box">
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo" class="logo" />
            <div class="title">SMPN 2 PAJANGAN</div>
        </div>
        <div class="card-body">
            <div class="judul-ujian">UJIAN BERBASIS ONLINE</div>
            <div id="locationBlocked" style="display: none; color: red; margin-bottom: 10px; font-weight: bold; text-align: center;">
                AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!
            </div>
            <p class="message" id="message"></p>
            <p id="locationStatus" style="color: gray; font-size: 12px; text-align: center;">Memuat status lokasi...</p>

            <div class="custom-dropdown-container">
                <div id="customSelectKelasDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Kelas --">
                    -- Pilih Kelas --
                </div>
                <input type="hidden" id="selectKelas" value="" /> </div>

            <div class="custom-dropdown-container">
                <div id="customSelectNamaSiswaDisplay" class="custom-dropdown-display" data-placeholder="-- Pilih Nama Siswa --">
                    -- Pilih Nama Siswa --
                </div>
                <input type="hidden" id="selectNamaSiswa" value="" /> </div>

            <input type="text" id="inputToken" placeholder="TOKEN-IDSiswa (Contoh: ABCDE-001)" maxlength="14" />
            <button id="loginBtn" onclick="cekToken()" disabled>Login</button>
        </div>
        <div class="footer">
            Â© Admin SMPN 2 Pajangan<br>
            <span id="datetime"></span>
        </div>
    </div>

    <div id="examContainer" style="display: none;">
        <div id="countdownDisplay"></div>
        <iframe id="examIframe" src="" frameborder="0"></iframe>
        <div id="warningOverlay" style="display: none;">
            <div class="warning-content-box">
                <div id="warningCountdown"></div>
                <div id="warningMessage">SEGERA KIRIMKAN JAWABAN, JANGAN SAMPAI KEHABISAN WAKTU!</div>
            </div>
        </div>

        <div id="lockedOverlay" style="display: none;">
            <div class="locked-content">
                <h2 id="lockedTitle">WAKTU HABIS</h2>
                <p id="lockedMessage">Silahkan masukkan password untuk membuka ujian!</p>
                <input type="password" id="passwordInput" placeholder="Masukkan Password" />
                <button id="unlockButton">BUKA KUNCI</button>
                <p id="unlockErrorMessage" style="display: none;"></p>
            </div>
        </div>

        <div id="fullscreenExitWarningOverlay" style="display: none;">
            <div class="exit-warning-content">
                <h2>PERINGATAN!</h2>
                <p>Anda telah keluar dari mode layar penuh. Mohon kembali ke mode layar penuh untuk melanjutkan ujian.</p>
                <button id="reEnterFullscreenBtn" class="exit-warning-button">Kembali ke Layar Penuh</button>
            </div>
        </div>

        <button id="refreshPageBtn">Refresh Halaman</button>
    </div>

    <div id="confirmModal">
        <div class="modal-content">
            <h4>DATA UJIAN ONLINE</h4>
            <table class="info-table">
                <tr>
                    <td>ID Siswa</td>
                    <td>: <span id="modalIdSiswa"></span></td>
                </tr>
                <tr>
                    <td>Nama Lengkap</td>
                    <td>: <span id="modalNamaLengkap"></span></td>
                </tr>
                <tr>
                    <td>Kelas</td>
                    <td>: <span id="modalKelas"></span></td>
                </tr>
                <tr>
                    <td>Mapel</td>
                    <td>: <span id="modalMapel"></span></td>
                </tr>
                <tr>
                    <td>Waktu Ujian</td>
                    <td>: <span id="modalExamDuration"></span></td>
                </tr>
            </table>

            <div class="checkbox-container">
                <input type="checkbox" id="confirmCheckbox">
                <label for="confirmCheckbox">Data di atas sudah benar</label>
            </div>
            <p id="modalMessage" style="display: none;"></p> <div class="button-container">
                <button id="btnLanjut">Lanjutkan</button>
                <button id="btnBatal" onclick="tutupModal()">Batal</button>
            </div>
        </div>
    </div>

    <div id="fullscreenOverlay" style="display: none;">
        <div class="overlay-content">
            <h2 class="overlay-title">PERHATIKAN HAL-HAL BERIKUT:</h2>
            <ul class="overlay-instructions">
                <li>Kerjakan ujian dengan sungguh-sungguh</li>
                <li>Pastikan jaringan kamu dalam kondisi baik</li>
                <li>Jika Anda keluar dari aplikasi, <strong>jawaban akan hilang!</strong></li>
                <li>Jika waktu habis, <strong>ujian Anda akan terkunci</strong></li>
            </ul>
            <button id="overlayUnderstandBtn" class="overlay-button">SAYA MENGERTI</button>
        </div>
    </div>

    <div id="submissionConfirmationOverlay">
        <div class="submission-content"> <h1>SELAMAT!</h1>
            <p>JAWABAN ANDA BERHASIL TERKIRIM!</p>
            <button id="backToLoginFromSubmissionBtn">KEMBALI</button>
        </div>
    </div>

    <div id="classModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Kelas</h4>
            <ul id="classModalList" class="custom-modal-list">
                </ul>
            </div>
    </div>

    <div id="studentModal" class="custom-modal">
        <div class="custom-modal-content">
            <h4>Pilih Nama Siswa</h4>
            <ul id="studentModalList" class="custom-modal-list">
                </ul>
            </div>
    </div>

    <div id="refreshWarningOverlay">
        <div class="refresh-warning-content">
            <h2>PERINGATAN!</h2>
            <p>Merefresh halaman akan **MENGHILANGKAN JAWABAN** Anda yang belum tersimpan di dalam Google Form. Pastikan Anda sudah menyimpan jawaban Anda sebelum melanjutkan.</p>
            <div class="refresh-warning-buttons">
                <button id="continueRefreshBtn">Lanjutkan Refresh</button>
                <button id="cancelRefreshBtn">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, runTransaction, set, onValue, off } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAOBCX8x60pYqxtXmXMz2xc5dwC3HJH5EE",
            authDomain: "ujian-online-berbasis-android.firebaseapp.com",
            databaseURL: "https://ujian-online-berbasis-android-default-rtdb.firebaseio.com",
            projectId: "ujian-online-berbasis-android",
            storageBucket: "ujian-online-berbasis-android.appspot.com",
            messagingSenderId: "923446282537",
            appId: "1:923446282537:web:60d374dde8aca61f6a0f38"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // References to Firebase nodes
        const settingsRef = ref(db, 'setlokasi');
        const studentsRef = ref(db, 'students');
        const tokensRef = ref(db, 'tokens');
        const examAccessStatusRef = ref(db, 'exam_access_status');
        const adminSettingsRef = ref(db, 'admin_settings');
        const submittedExamsRef = ref(db, 'submitted_exams');

        // Location feature control variables
        let isLocationEnabled = true;
        let firebaseAllowedRadiusKm = 0.075;
        let examUnlockPassword = '';

        // Allowed central location coordinates (static on the student side)
        const allowedLatitude = -7.8589546;
        const allowedLongitude = 110.2655596;

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const examContainer = document.getElementById('examContainer');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const examIframe = document.getElementById('examIframe');
        const fullscreenOverlay = document.getElementById('fullscreenOverlay');
        const overlayUnderstandBtn = document.getElementById('overlayUnderstandBtn');
        const warningOverlay = document.getElementById('warningOverlay');
        const warningCountdown = document.getElementById('warningCountdown');
        const lockedOverlay = document.getElementById('lockedOverlay');
        const passwordInput = document.getElementById('passwordInput');
        const unlockButton = document.getElementById('unlockButton');
        const unlockErrorMessage = document.getElementById('unlockErrorMessage');

        const locationBlockedDiv = document.getElementById('locationBlocked');
        const message = document.getElementById('message');
        const loginBtn = document.getElementById('loginBtn');
        const confirmModal = document.getElementById('confirmModal');
        const locationStatus = document.getElementById('locationStatus');
        const inputToken = document.getElementById('inputToken');
        
        // Custom Dropdown Elements
        const customSelectKelasDisplay = document.getElementById('customSelectKelasDisplay');
        const hiddenSelectKelas = document.getElementById('selectKelas'); // Hidden input
        const customSelectNamaSiswaDisplay = document.getElementById('customSelectNamaSiswaDisplay');
        const hiddenSelectNamaSiswa = document.getElementById('selectNamaSiswa'); // Hidden input

        const confirmCheckbox = document.getElementById('confirmCheckbox');
        const modalMessage = document.getElementById('modalMessage');
        const modalExamDuration = document.getElementById('modalExamDuration');

        // Elements for Submission Confirmation Overlay
        const submissionConfirmationOverlay = document.getElementById('submissionConfirmationOverlay');
        const backToLoginFromSubmissionBtn = document.getElementById('backToLoginFromSubmissionBtn');

        // NEW: New DOM elements for security features
        const fullscreenExitWarningOverlay = document.getElementById('fullscreenExitWarningOverlay');
        const reEnterFullscreenBtn = document.getElementById('reEnterFullscreenBtn');
        
        // NEW: Refresh Button and Warning Overlay elements
        const refreshPageBtn = document.getElementById('refreshPageBtn');
        const refreshWarningOverlay = document.getElementById('refreshWarningOverlay');
        const continueRefreshBtn = document.getElementById('continueRefreshBtn');
        const cancelRefreshBtn = document.getElementById('cancelRefreshBtn');


        // Custom Modal Elements
        const classModal = document.getElementById('classModal');
        const classModalList = document.getElementById('classModalList');
        const studentModal = document.getElementById('studentModal');
        const studentModalList = document.getElementById('studentModalList');


        let allStudentsData = [];
        let selectedStudentData = null;
        let isLocationValid = false;
        let foundTokenGlobal = null;
        let countdownInterval;
        let currentTotalSeconds;
        let submissionListenerRef = null;

        // NEW: Control variable for exam status
        let isInExamMode = false;

        // --- Utility Functions ---

        /**
         * Pads the student ID to ensure it has 3 digits.
         * @param {string|number} id - Student ID.
         * @returns {string} Padded student ID.
         */
        function padStudentId(id) {
            return String(id).padStart(3, '0');
        }

        /**
         * Checks if the device is a touch device.
         * @returns {boolean} True if touch device, false otherwise.
         */
        function isTouchDevice() {
            return window.matchMedia('(pointer: coarse)').matches;
        }

        /**
         * Calculates the distance between two geographical coordinates using the Haversine formula.
         * @param {number} lat1 - Latitude of point 1.
         * @param {number} lon1 - Longitude of point 1.
         * @param {number} lat2 - Latitude of point 2.
         * @param {number} lon2 - Longitude of point 2.
         * @returns {number} Distance in kilometers.
         */
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const d = R * c; // Distance in km
            return d;
        }

        /**
         * Converts degrees to radians.
         * @param {number} deg - Angle in degrees.
         * @returns {number} Angle in radians.
         */
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- UI Update Functions ---

        /**
         * Updates the current date and time displayed in the footer.
         */
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

        /**
         * Formats the token input to uppercase and adds a hyphen after 5 characters.
         * Provides visual feedback (green/red) on the input border.
         * @param {HTMLInputElement} inputElement - The input field for the token.
         * @returns {void}
         */
        window.formatToken = function (inputElement) {
            if (!inputElement || typeof inputElement.value === 'undefined') {
                console.error("Error: inputElement or its value is undefined in formatToken.");
                return;
            }

            // Remove previous feedback classes
            inputElement.classList.remove('is-valid', 'is-invalid');

            let value = inputElement.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            if (value.length > 5 && value.indexOf('-') === -1) {
                value = value.substring(0, 5) + '-' + value.substring(5);
            }
            inputElement.value = value; // Update the input field with the formatted value

            const tokenRegex = /^[A-Z0-9]{5}-[0-9]{3}$/; // Example: ABCDE-001
            
            if (tokenRegex.test(value)) {
                inputElement.classList.add('is-valid');
            } else if (value.length >= 9) { // If length reaches expected format (9 characters) but is not valid
                inputElement.classList.add('is-invalid');
            }
            // For partial input, no color (neither valid nor invalid)

            updateLoginButtonStatus();
        };

        /**
         * Updates the enabled/disabled status and opacity of the Login button
         * based on location validity and input field completeness.
         * @returns {void}
         */
        function updateLoginButtonStatus() {
            const isLocationCheckPassed = (isLocationEnabled && isTouchDevice()) ? isLocationValid : true;
            // Use hidden input values for checks
            const isClassAndStudentSelected = hiddenSelectKelas.value !== "" && hiddenSelectNamaSiswa.value !== "";
            const isTokenInputFilled = inputToken.value.trim() !== "";

            // Enable/disable inputToken based on class and student selection
            if (isClassAndStudentSelected) {
                inputToken.disabled = false;
            } else {
                inputToken.disabled = true;
                inputToken.value = ""; // Clear token if class/student is unselected
                inputToken.classList.remove('is-valid', 'is-invalid'); // Clear feedback
            }

            // Enable/disable custom select displays
            if (hiddenSelectKelas.value === "") {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            }

            if (isLocationCheckPassed && isClassAndStudentSelected && isTokenInputFilled) {
                loginBtn.disabled = false;
                loginBtn.style.opacity = 1;
            } else {
                loginBtn.disabled = true;
                loginBtn.style.opacity = 0.6;
            }
        }

        /**
         * Hides the confirmation modal and resets the UI.
         * @returns {void}
         */
        window.tutupModal = function () {
            confirmModal.classList.remove('show');
            message.textContent = "";
            modalMessage.textContent = "";
            confirmCheckbox.checked = false;
            updateLoginButtonStatus();
            sessionStorage.clear(); // Clear session storage if user cancels login
        };

        // --- Location Handling ---

        /**
         * Checks the user's current location against the allowed coordinates and radius.
         * Updates UI elements based on location validity.
         * @param {number} latitude - Latitude of point 1.
         * @param {number} longitude - Longitude of point 1.
         * @returns {void}
         */
        function checkLocation(latitude, longitude) {
            const distance = getDistanceFromLatLonInKm(allowedLatitude, allowedLongitude, latitude, longitude);
            if (distance <= firebaseAllowedRadiusKm) {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.textContent = "Lokasi valid.";
                locationStatus.style.color = "green";
            } else {
                locationBlockedDiv.style.display = 'block';
                locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
                isLocationValid = false;
                locationStatus.textContent = `Anda berada ${distance.toFixed(2)} km dari lokasi yang diizinkan.`;
                locationStatus.style.color = "red";
            }
            updateLoginButtonStatus();
        }

        /**
         * Handler for successful geolocation retrieval.
         * @param {GeolocationPosition} position - Geolocation position object.
         * @returns {void}
         */
        function handleLocation(position) {
            checkLocation(position.coords.latitude, position.coords.longitude);
        }

        /**
         * Handler for geolocation errors.
         * @param {GeolocationPositionError} error - Geolocation error object.
         * @returns {void}
         */
        function handleLocationError(error) {
            console.error("Error getting location:", error);

            locationBlockedDiv.style.display = 'block';
            locationBlockedDiv.textContent = 'AKSES UJIAN DIBLOKIR, silahkan aktifkan lokasi perangkat Anda di SMPN 2 Pajangan! Setelah diaktifkan, silahkan refresh halaman login!';
            message.style.color = "orange";

            let errorMessage = "Terjadi kesalahan tak terduga dengan layanan lokasi. Pastikan GPS aktif dan izin lokasi diberikan.";

            if (error && typeof error.code === 'number') {
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = "Lokasi belum diaktifkan, mohon aktifkan lokasi di pengaturan perangkat Anda.";
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = "Informasi lokasi tidak tersedia.";
                        break;
                    case error.TIMEOUT:
                        errorMessage = "Waktu permintaan lokasi habis.";
                        break;
                }
            } else if (error && error.message) {
                errorMessage = `Terjadi kesalahan: ${error.message}`;
            }

            message.textContent = errorMessage;
            isLocationValid = false;
            updateLoginButtonStatus();
        }

        /**
         * Starts geolocation monitoring if location is enabled and it's a touch device.
         * Otherwise, location is considered valid.
         * @returns {void}
         */
        function getLocation() {
            if (isLocationEnabled && isTouchDevice()) {
                locationStatus.style.display = 'block';
                locationStatus.textContent = 'Mencari lokasi Anda...';
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(handleLocation, handleLocationError, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                } else {
                    locationBlockedDiv.style.display = 'block';
                    locationBlockedDiv.textContent = 'Geolocation tidak didukung oleh perangkat ini.';
                    message.style.color = "red";
                    isLocationValid = false;
                    updateLoginButtonStatus();
                }
            } else {
                locationBlockedDiv.style.display = 'none';
                isLocationValid = true;
                locationStatus.style.display = 'none';
                updateLoginButtonStatus();
            }
        }

        // --- Data Loading and Filtering ---

        /**
         * Loads all student data from Firebase and populates the class dropdown.
         * Also calls getLocation() after data is loaded.
         * @returns {Promise<void>}
         */
        async function loadStudentsAndPopulateClassDropdown() {
            customSelectKelasDisplay.classList.add('disabled');
            customSelectNamaSiswaDisplay.classList.add('disabled');
            inputToken.disabled = true; // Disable token input initially
            message.innerHTML = `Memuat data siswa... <span class="spinner"></span>`;
            try {
                const snapshot = await get(studentsRef);
                if (snapshot.exists()) {
                    allStudentsData = Object.values(snapshot.val());
                    const classes = new Set();
                    allStudentsData.forEach(student => {
                        if (student.class) {
                            classes.add(student.class);
                        }
                    });

                    classModalList.innerHTML = ''; // Clear previous options
                    Array.from(classes).sort((a, b) => {
                        const numA = parseInt(a.match(/\d+/));
                        const numB = parseInt(b.match(/\d+/));
                        if (numA && numB && numA !== numB) {
                            return numA - numB;
                        }
                        return a.localeCompare(b);
                    }).forEach(cls => {
                        const listItem = document.createElement('li');
                        listItem.textContent = cls;
                        listItem.dataset.value = cls;
                        listItem.addEventListener('click', () => selectClass(cls));
                        classModalList.appendChild(listItem);
                    });
                    customSelectKelasDisplay.classList.remove('disabled');
                    message.textContent = "";
                } else {
                    message.style.color = "orange";
                    message.textContent = "Tidak ada data siswa ditemukan di database.";
                }
            } catch (error) {
                console.error("Gagal memuat data siswa:", error);
                message.style.color = "red";
                message.textContent = "Gagal memuat data siswa dari database.";
            } finally {
                getLocation();
            }
        }

        /**
         * Filters the student name dropdown based on the selected class.
         * @returns {void}
         */
        function filterStudentsByClass() {
            const selectedClass = hiddenSelectKelas.value;
            studentModalList.innerHTML = ''; // Clear previous options
            hiddenSelectNamaSiswa.value = ''; // Reset hidden student value
            customSelectNamaSiswaDisplay.textContent = customSelectNamaSiswaDisplay.dataset.placeholder;
            customSelectNamaSiswaDisplay.classList.remove('selected');
            selectedStudentData = null;

            if (selectedClass) {
                const filteredStudents = allStudentsData.filter(student => student.class === selectedClass);
                filteredStudents.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.textContent = student.name;
                    listItem.dataset.value = student.id;
                    listItem.addEventListener('click', () => selectStudent(student.id, student.name));
                    studentModalList.appendChild(listItem);
                });
                customSelectNamaSiswaDisplay.classList.remove('disabled');
            } else {
                customSelectNamaSiswaDisplay.classList.add('disabled');
            }
            updateLoginButtonStatus(); // Call to enable/disable inputToken
        }

        // --- Custom Dropdown Modal Functions ---

        /**
         * Opens the class selection modal.
         * @returns {void}
         */
        function openClassModal() {
            if (customSelectKelasDisplay.classList.contains('disabled')) return;
            classModal.classList.add('show');
        }

        /**
         * Closes the class selection modal.
         * @returns {void}
         */
        function closeClassModal() {
            classModal.classList.remove('show');
        }

        /**
         * Selects a class and updates the display.
         * @param {string} className - The name of the selected class.
         * @returns {void}
         */
        function selectClass(className) {
            hiddenSelectKelas.value = className;
            customSelectKelasDisplay.textContent = className;
            customSelectKelasDisplay.classList.add('selected');
            closeClassModal();
            filterStudentsByClass(); // Re-filter students based on new class selection
        }

        /**
         * Opens the student selection modal.
         * @returns {void}
         */
        function openStudentModal() {
            if (customSelectNamaSiswaDisplay.classList.contains('disabled')) return;
            studentModal.classList.add('show');
        }

        /**
         * Closes the student selection modal.
         * @returns {void}
         */
        function closeStudentModal() {
            studentModal.classList.remove('show');
        }

        /**
         * Selects a student and updates the display.
         * @param {string} studentId - The ID of the selected student.
         * @param {string} studentName - The name of the selected student.
         * @returns {void}
         */
        function selectStudent(studentId, studentName) {
            hiddenSelectNamaSiswa.value = studentId;
            customSelectNamaSiswaDisplay.textContent = studentName;
            customSelectNamaSiswaDisplay.classList.add('selected');
            selectedStudentData = allStudentsData.find(student => student.id === studentId);
            closeStudentModal();
            updateLoginButtonStatus();
        }


        // --- Countdown Logic ---
        /**
         * Starts the exam countdown.
         * @param {number} durationInSeconds - Exam duration in seconds.
         * @returns {void}
         */
        function startCountdown(durationInSeconds) {
            currentTotalSeconds = durationInSeconds;

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownDisplay.style.display = 'block';

            countdownInterval = setInterval(async () => {
                const minutes = Math.floor(currentTotalSeconds / 60);
                const seconds = currentTotalSeconds % 60;

                const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                countdownDisplay.textContent = `Sisa Waktu: ${formattedTime}`;

                if (currentTotalSeconds <= 300 && currentTotalSeconds > 0) {
                    countdownDisplay.style.display = 'none';
                    warningCountdown.textContent = formattedTime;
                    // Show warning overlay with fade-in effect
                    warningOverlay.style.display = 'flex';
                    setTimeout(() => { warningOverlay.style.opacity = 1; }, 10);
                } else {
                    // Hide warning overlay with fade-out effect
                    warningOverlay.style.opacity = 0;
                    setTimeout(() => { warningOverlay.style.display = 'none'; }, 300); // Match transition duration
                }

                if (currentTotalSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownDisplay.textContent = "Waktu Habis! Ujian Terkunci.";
                    countdownDisplay.style.display = 'block';
                    warningOverlay.style.opacity = 0; // Ensure it fades out
                    setTimeout(() => { warningOverlay.style.display = 'none'; }, 300);
                    showLockedOverlay();
                } else {
                    currentTotalSeconds--;
                }
            }, 1000);
        }

        // --- Overlay Logic ---
        /**
         * Displays the fullscreen overlay with initial instructions.
         * @returns {void}
         */
        function showOverlay() {
            fullscreenOverlay.style.display = 'flex';
            setTimeout(() => { fullscreenOverlay.style.opacity = 1; }, 10); // Small delay to trigger CSS transition
            document.body.style.overflow = 'hidden';
            examIframe.style.pointerEvents = 'none'; // Block interaction with iframe when instruction overlay is active
        }

        /**
         * Hides the fullscreen overlay with initial instructions.
         * Initiates fullscreen mode after the overlay is hidden.
         * @returns {void}
         */
        function hideOverlay() {
            fullscreenOverlay.style.opacity = 0;
            setTimeout(() => {
                fullscreenOverlay.style.display = 'none';
                document.body.style.overflow = '';
                examIframe.style.pointerEvents = 'auto'; // Allow interaction with iframe after instruction overlay is gone
                attemptFullscreen(); // NEW: Call attemptFullscreen here
            }, 300); // Match CSS transition duration
        }

        /**
         * Displays the locked overlay when time runs out.
         * Also ensures the exam remains blurred and non-interactive.
         * @returns {void}
         */
        function showLockedOverlay() {
            lockedOverlay.style.display = 'flex';
            setTimeout(() => { lockedOverlay.style.opacity = 1; }, 10);
            document.body.style.overflow = 'hidden';
            examIframe.classList.add('blurred'); // Add blurred class
            passwordInput.value = '';
            unlockErrorMessage.style.display = 'none';
            // Stop fullscreen enforcement if locked
            document.removeEventListener('fullscreenchange', handleFullscreenChange);
            document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
            document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.removeEventListener('msfullscreenchange', handleFullscreenChange);
            // Hide fullscreen warning if it was active
            fullscreenExitWarningOverlay.classList.remove('show');
            fullscreenExitWarningOverlay.style.display = 'none';
            refreshPageBtn.style.display = 'none'; // Hide refresh button when locked
        }

        /**
         * Handles the attempt to unlock the exam.
         * @returns {Promise<void>}
         */
        async function handleUnlockExam() {
            const enteredPassword = passwordInput.value.trim();
            if (enteredPassword === examUnlockPassword) {
                lockedOverlay.style.opacity = 0;
                setTimeout(() => {
                    lockedOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                    examIframe.classList.remove('blurred'); // Remove blurred class
                    unlockErrorMessage.style.display = 'none';
                    // Re-enable fullscreen enforcement after unlock (if needed)
                    if (isInExamMode) {
                        attemptFullscreen(); // Re-attempt fullscreen
                        // Re-add fullscreen listeners
                        document.addEventListener('fullscreenchange', handleFullscreenChange);
                        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
                        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                        document.addEventListener('msfullscreenchange', handleFullscreenChange);
                        refreshPageBtn.style.display = 'block'; // Show refresh button again
                    }
                }, 300);
            } else {
                unlockErrorMessage.textContent = "Password salah!";
                unlockErrorMessage.style.display = 'block';
            }
        }

        /**
         * Displays the submission confirmation overlay.
         * @returns {void}
         */
        function showSubmissionConfirmationOverlay() {
            sessionStorage.clear(); // Clear session storage on successful submission
            loginContainer.style.display = 'none'; // Ensure login container is hidden
            examContainer.style.opacity = 0; // Start fade out for exam container
            setTimeout(() => {
                examContainer.style.display = 'none'; // Hide exam container after fade out
                submissionConfirmationOverlay.style.display = 'flex'; // Show submission overlay
                setTimeout(() => { submissionConfirmationOverlay.style.opacity = 1; }, 10); // Fade in submission overlay
                document.body.style.overflow = 'hidden';
                if (countdownInterval) clearInterval(countdownInterval);
                if (submissionListenerRef) {
                    off(submissionListenerRef);
                    submissionListenerRef = null;
                }
                isInExamMode = false; // Exit exam mode
                toggleExamSecurityFeatures(false); // Disable security features
                document.exitFullscreen(); // Exit fullscreen if still active
                refreshPageBtn.style.display = 'none'; // Hide refresh button
            }, 500); // Match examContainer transition duration
        }

        /**
         * Hides the submission confirmation overlay.
         * @returns {void}
         */
        function hideSubmissionConfirmationOverlay() {
            submissionConfirmationOverlay.style.opacity = 0;
            setTimeout(() => {
                submissionConfirmationOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }, 300); // Match CSS transition duration
        }

        /**
         * Enables/disables exam security features (prevent copy/paste/cut, text selection).
         * @param {boolean} enable - True to enable, false to disable.
         * @returns {void}
         */
        function toggleExamSecurityFeatures(enable) {
            if (enable) {
                // Prevent copy, cut, paste
                document.addEventListener('copy', preventDefaultBehavior);
                document.addEventListener('cut', preventDefaultBehavior);
                document.addEventListener('paste', preventDefaultBehavior);

                // Prevent text selection (CSS is handled by adding/removing class)
                document.body.classList.add('no-select');
                document.addEventListener('selectstart', preventDefaultBehavior); // For older browsers
                document.addEventListener('contextmenu', preventDefaultBehavior); // Prevent right-click/long-press menu
                
                // Show refresh button
                refreshPageBtn.style.display = 'block';
            } else {
                // Re-enable copy, cut, paste
                document.removeEventListener('copy', preventDefaultBehavior);
                document.removeEventListener('cut', preventDefaultBehavior);
                document.removeEventListener('paste', preventDefaultBehavior);

                // Re-enable text selection
                document.body.classList.remove('no-select');
                document.removeEventListener('selectstart', preventDefaultBehavior);
                document.removeEventListener('contextmenu', preventDefaultBehavior);

                // Hide refresh button
                refreshPageBtn.style.display = 'none';
            }
        }

        /**
         * Helper function to prevent default event behavior.
         * @param {Event} e - Event object.
         * @returns {boolean} Always false to prevent default.
         */
        function preventDefaultBehavior(e) {
            e.preventDefault();
            return false;
        }

        /**
         * Attempts to enter fullscreen mode on the examContainer.
         * @returns {void}
         */
        function attemptFullscreen() {
            // Check if already in fullscreen to prevent errors
            if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                console.log("Already in fullscreen mode.");
                return;
            }

            if (examContainer.requestFullscreen) {
                examContainer.requestFullscreen().catch(err => {
                    console.warn(`Failed to enter fullscreen: ${err.message}`);
                    // Notifying the user might be necessary, but not blocking
                });
            } else if (examContainer.mozRequestFullScreen) { /* Firefox */
                examContainer.mozRequestFullScreen().catch(err => console.warn(`Failed to enter fullscreen (Firefox): ${err.message}`));
            } else if (examContainer.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                examContainer.webkitRequestFullscreen().catch(err => console.warn(`Failed to enter fullscreen (Webkit): ${err.message}`));
            } else if (examContainer.msRequestFullscreen) { /* IE/Edge */
                examContainer.msRequestFullscreen().catch(err => console.warn(`Failed to enter fullscreen (MS): ${err.message}`));
            }
        }

        /**
         * Handles fullscreen status changes.
         * @returns {void}
         */
        function handleFullscreenChange() {
            if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement && isInExamMode) {
                // Exited fullscreen while in exam mode
                fullscreenExitWarningOverlay.style.display = 'flex';
                setTimeout(() => { fullscreenExitWarningOverlay.style.opacity = 1; }, 10);
                examIframe.classList.add('blurred'); // Blur iframe
                document.body.style.overflow = 'hidden';
            } else if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                // Entered fullscreen
                fullscreenExitWarningOverlay.style.opacity = 0;
                setTimeout(() => { fullscreenExitWarningOverlay.style.display = 'none'; }, 300);
                examIframe.classList.remove('blurred'); // Unblur
                document.body.style.overflow = '';
            }
        }

        // Function to start submission status listener when exam is active
        function startSubmissionStatusListener() {
            if (!foundTokenGlobal || !selectedStudentData) {
                console.warn("Token or student data incomplete to start submission listener.");
                return;
            }

            const tokenPrefix = inputToken.value.split('-')[0].trim().toUpperCase();
            const studentId = selectedStudentData.id;
            
            // Get reference to the specific student path in submitted_exams
            const studentSubmissionRef = child(submittedExamsRef, `${tokenPrefix}/${studentId}`);

            // Ensure previous listener is detached before attaching a new one
            if (submissionListenerRef) {
                off(submissionListenerRef);
                submissionListenerRef = null;
            }

            // Save listener reference so it can be detached later
            submissionListenerRef = studentSubmissionRef; 

            // Attach onValue listener
            onValue(studentSubmissionRef, (snapshot) => {
                if (snapshot.exists() && snapshot.val().isSubmitted === true) {
                    console.log("Detection: Student's answers have been recorded in Firebase in real-time.");
                    // Only show overlay if examContainer is still visible (student is in exam)
                    if (examContainer.style.display === 'flex') {
                        showSubmissionConfirmationOverlay();
                        examIframe.src = ''; // Optional: Clear iframe so no exam content is visible
                    }
                }
            }, (error) => {
                console.error("Failed to listen for submission status:", error);
            });
            console.log("Real-time listener for submission status started.");
        }

        /**
         * Restores exam state from sessionStorage when the page is refreshed.
         * @returns {void}
         */
        function restoreExamState() {
            const storedIsInExamMode = sessionStorage.getItem('isInExamMode');
            if (storedIsInExamMode === 'true') {
                const storedSelectedStudentData = JSON.parse(sessionStorage.getItem('selectedStudentData'));
                const storedFoundTokenGlobal = JSON.parse(sessionStorage.getItem('foundTokenGlobal'));
                const storedExamIframeSrc = sessionStorage.getItem('examIframeSrc');
                const storedExamStartTime = parseInt(sessionStorage.getItem('examStartTime'), 10);
                const storedExamDurationMinutes = parseInt(sessionStorage.getItem('examDurationMinutes'), 10);

                if (storedSelectedStudentData && storedFoundTokenGlobal && storedExamIframeSrc && storedExamStartTime && storedExamDurationMinutes) {
                    // Restore global variables
                    selectedStudentData = storedSelectedStudentData;
                    foundTokenGlobal = storedFoundTokenGlobal;
                    isInExamMode = true;

                    // Calculate remaining time
                    const elapsedSeconds = Math.floor((Date.now() - storedExamStartTime) / 1000);
                    const totalDurationSeconds = storedExamDurationMinutes * 60;
                    const remainingSeconds = totalDurationSeconds - elapsedSeconds;

                    if (remainingSeconds > 0) {
                        // Transition to exam view
                        loginContainer.style.display = 'none';
                        examContainer.style.display = 'flex';
                        examContainer.style.opacity = 1;

                        examIframe.src = storedExamIframeSrc;
                        startCountdown(remainingSeconds); // Start countdown with remaining seconds
                        toggleExamSecurityFeatures(true);
                        attemptFullscreen();
                        startSubmissionStatusListener();
                        console.log("Exam state restored from session storage.");
                    } else {
                        // Time has already run out, show locked overlay
                        sessionStorage.clear(); // Clear session storage
                        loginContainer.style.display = 'none';
                        examContainer.style.display = 'flex';
                        examContainer.style.opacity = 1;
                        countdownDisplay.textContent = "Waktu Habis! Ujian Terkunci.";
                        countdownDisplay.style.display = 'block';
                        showLockedOverlay();
                        console.log("Exam time already expired, showing locked overlay.");
                    }
                } else {
                    console.warn("Incomplete exam state found in session storage. Clearing.");
                    sessionStorage.clear(); // Clear incomplete state
                }
            }
        }


        // --- Login and Modal Logic ---

        /**
         * Handles the "Continue" button click in the confirmation modal.
         * Records exam access and redirects to Google Form.
         * @param {string} userEnteredTokenId - The TOKEN-IDSiswa value entered by the user.
         * @param {number} examDurationMinutes - The exam duration in minutes.
         * @returns {Promise<void>}
         */
        async function handleLanjutClick(userEnteredTokenId, examDurationMinutes) {
            if (!confirmCheckbox.checked) {
                modalMessage.style.display = 'block';
                modalMessage.textContent = "Anda harus mencentang 'Data di atas sudah benar' untuk melanjutkan.";
                return;
            } else {
                modalMessage.style.display = 'none';
            }

            message.innerHTML = `Mencatat akses ujian... <span class="spinner"></span>`;
            confirmModal.classList.remove('show');

            if (!foundTokenGlobal || !selectedStudentData) {
                console.error("Error: Token data or student data is missing for redirection.");
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat menyiapkan tautan ujian. Pastikan koneksi internet Anda stabil dan coba lagi.";
                updateLoginButtonStatus();
                loginContainer.style.display = 'flex'; // Ensure login container is visible
                examContainer.style.display = 'none'; // Ensure exam container is hidden
                sessionStorage.clear(); // Clear session storage on error
                return;
            }

            // Extract TOKEN-ID Prefix from userEnteredTokenId (e.g., ABCDE from ABCDE-001)
            const tokenPrefixFromInput = userEnteredTokenId.split('-')[0].trim().toUpperCase();

            // Check submission status: If already submitted, display message on login page
            const hasSubmittedSnapshot = await get(child(submittedExamsRef, `${tokenPrefixFromInput}/${selectedStudentData.id}`));
            if (hasSubmittedSnapshot.exists() && hasSubmittedSnapshot.val().isSubmitted === true) {
                message.style.color = "red";
                message.textContent = "Anda sudah menyelesaikan ujian ini dan tidak dapat login kembali.";
                updateLoginButtonStatus();
                sessionStorage.clear(); // Clear session storage if already submitted
                return; // Stop further execution
            }

            const examAccessRef = child(examAccessStatusRef, `${foundTokenGlobal.key}/${selectedStudentData.id}`);

            try {
                await runTransaction(examAccessRef, (currentAccess) => {
                    const nowAccess = Date.now();
                    const SPAM_THRESHOLD_MS = 5000;

                    if (currentAccess === null) {
                        return {
                            firstAccessTime: nowAccess,
                            lastAccessTime: nowAccess,
                            accessCount: 1
                        };
                    } else {
                        if (nowAccess - (currentAccess.lastAccessTime || 0) > SPAM_THRESHOLD_MS) {
                            currentAccess.accessCount = (currentAccess.accessCount || 0) + 1;
                            currentAccess.lastAccessTime = nowAccess;
                        } else {
                            currentAccess.lastAccessTime = nowAccess; // Fix: should be lastAccessTime
                        }
                        return currentAccess;
                    }
                });
                console.log(`Access to token ${foundTokenGlobal.key} by student ${selectedStudentData.id} successfully recorded.`);

                // Get entry IDs from token data in Firebase
                const tokenEntryId = foundTokenGlobal.tokenEntryId;
                const nameEntryId = foundTokenGlobal.nameEntryId;
                const classEntryId = foundTokenGlobal.classEntryId;

                if (!tokenEntryId || !nameEntryId || !classEntryId) {
                    console.error("Error: Google Form Entry IDs not found in Firebase token data.");
                    message.style.color = "red";
                    message.textContent = "Konfigurasi ujian tidak lengkap. Harap hubungi administrator.";
                    updateLoginButtonStatus();
                    loginContainer.style.display = 'flex'; // Ensure login container is visible
                    examContainer.style.display = 'none'; // Ensure exam container is hidden
                    sessionStorage.clear(); // Clear session storage on error
                    return;
                }

                let googleFormUrl = `${foundTokenGlobal.url}?usp=pp_url` +
                                    `&entry.${tokenEntryId}=${encodeURIComponent(userEnteredTokenId)}` +
                                    `&entry.${nameEntryId}=${encodeURIComponent(selectedStudentData.name)}` +
                                    `&entry.${classEntryId}=${encodeURIComponent(selectedStudentData.class)}`;

                console.log("Redirecting to Google Form URL:", googleFormUrl);

                // Save state to sessionStorage before transitioning
                sessionStorage.setItem('isInExamMode', 'true');
                sessionStorage.setItem('selectedStudentData', JSON.stringify(selectedStudentData));
                sessionStorage.setItem('foundTokenGlobal', JSON.stringify(foundTokenGlobal));
                sessionStorage.setItem('examIframeSrc', googleFormUrl);
                sessionStorage.setItem('examStartTime', Date.now());
                sessionStorage.setItem('examDurationMinutes', examDurationMinutes);


                // Smooth transition from login to exam
                loginContainer.style.opacity = 0;
                setTimeout(() => {
                    loginContainer.style.display = 'none';
                    examContainer.style.display = 'flex';
                    setTimeout(() => {
                        examContainer.style.opacity = 1;
                        isInExamMode = true; // Set exam mode active
                        toggleExamSecurityFeatures(true); // Enable security features
                        // attemptFullscreen(); // OLD: This call is moved to hideOverlay()
                    }, 10);
                }, 500); // Match CSS transition duration for loginContainer fade out

                examIframe.src = googleFormUrl;
                startCountdown(examDurationMinutes * 60); // Pass duration in seconds
                showOverlay(); // Show initial instruction overlay

                history.pushState(null, '', location.href);
                startSubmissionStatusListener();

            } catch (error) {
                console.error("Failed to record token access or redirect:", error);
                message.style.color = "orange";
                message.textContent = "Gagal mencatat akses ujian, namun Anda akan tetap dialihkan. Pastikan koneksi internet Anda stabil.";
                // Ensure security features are disabled if failed to enter exam
                isInExamMode = false;
                toggleExamSecurityFeatures(false);
                sessionStorage.clear(); // Clear session storage on error

                // Fallback logic for redirection if initial transaction failed
                setTimeout(() => {
                    const tokenEntryId = foundTokenGlobal.tokenEntryId;
                    const nameEntryId = foundTokenGlobal.nameEntryId;
                    const classEntryId = foundTokenGlobal.classEntryId;

                    if (!tokenEntryId || !nameEntryId || !classEntryId) {
                        console.error("Error (fallback): Google Form Entry IDs not found in Firebase token data.");
                        return; // Do not attempt redirection if IDs are missing
                    }

                    let googleFormUrl = `${foundTokenGlobal.url}?usp=pp_url` +
                                        `&entry.${tokenEntryId}=${encodeURIComponent(userEnteredTokenId)}` +
                                        `&entry.${nameEntryId}=${encodeURIComponent(selectedStudentData.name)}` +
                                        `&entry.${classEntryId}=${encodeURIComponent(selectedStudentData.class)}`;

                    console.log("Redirecting to Google Form URL (fallback):", googleFormUrl);

                    // Smooth transition from login to exam (fallback)
                    loginContainer.style.opacity = 0;
                    setTimeout(() => {
                        loginContainer.style.display = 'none';
                        examContainer.style.display = 'flex';
                        setTimeout(() => {
                            examContainer.style.opacity = 1;
                            isInExamMode = true; // Set exam mode active
                            toggleExamSecurityFeatures(true); // Enable security features
                            // attemptFullscreen(); // OLD: This call is moved to hideOverlay()
                        }, 10);
                    }, 500); // Match CSS transition duration for loginContainer fade out

                    examIframe.src = googleFormUrl;
                    startCountdown(examDurationMinutes * 60); // Pass duration in seconds
                    showOverlay();
                    history.pushState(null, '', location.href);
                    startSubmissionStatusListener();
                }, 1500);
            } finally {
                // No need to updateLoginButtonStatus() here as we transition to exam view
            }
        }

        /**
         * Main function to check the entered token and student details.
         * Displays the confirmation modal if validation is successful.
         * @returns {Promise<void>}
         */
        window.cekToken = async function () {
            const selectedClass = hiddenSelectKelas.value; // Use hidden input
            const selectedStudentId = hiddenSelectNamaSiswa.value; // Use hidden input
            const fullInputToken = inputToken.value.trim(); // Example: ABCDE-001

            if (!selectedClass || !selectedStudentId || !fullInputToken) {
                message.style.color = "red";
                message.textContent = "Harap lengkapi semua pilihan (Kelas, Nama Siswa, dan Token).";
                updateLoginButtonStatus();
                return;
            }

            const parts = fullInputToken.split('-');
            if (parts.length !== 2) {
                message.style.color = "red";
                message.textContent = "Format Token-ID Siswa salah. Gunakan TOKEN-IDSiswa (Contoh: ABCDE-001).";
                updateLoginButtonStatus();
                return;
            }

            const inputTokenPrefix = parts[0].trim().toUpperCase(); // Get ABCDE
            const inputStudentIdFromToken = padStudentId(parts[1].trim()); // Get 001

            if (inputStudentIdFromToken !== selectedStudentId) {
                message.style.color = "red";
                message.textContent = "ID Siswa pada token tidak cocok dengan nama siswa yang dipilih.";
                updateLoginButtonStatus();
                return;
            }

            loginBtn.disabled = true;
            loginBtn.style.opacity = 0.6;
            message.style.color = "black";
            message.innerHTML = `Memproses data... <span class="spinner"></span>`;

            try {
                // Check submission status: If already submitted, display message on login page
                const tokenKeyForSubmittedCheck = inputTokenPrefix;
                const hasSubmittedSnapshot = await get(child(submittedExamsRef, `${tokenKeyForSubmittedCheck}/${selectedStudentId}`));

                if (hasSubmittedSnapshot.exists() && hasSubmittedSnapshot.val().isSubmitted === true) {
                    message.style.color = "red";
                    message.textContent = "Anda sudah menyelesaikan ujian ini dan tidak dapat login kembali.";
                    updateLoginButtonStatus();
                    sessionStorage.clear(); // Clear session storage if already submitted
                    return; // Stop further execution
                }

                const tokensSnapshot = await get(tokensRef);
                let foundToken = null;

                tokensSnapshot.forEach(child => {
                    const data = child.val();
                    // Match with inputTokenPrefix (e.g., ABCDE)
                    if (data.token.toUpperCase() === inputTokenPrefix) {
                        foundToken = { ...data, key: child.key }; // 'key' is the unique Firebase key (-NuX-Y-Z)
                        return true;
                    }
                });

                if (!foundToken) {
                    message.style.color = "red";
                    message.textContent = "Token ujian yang Anda masukkan tidak ditemukan. Mohon periksa kembali token Anda.";
                    updateLoginButtonStatus();
                    return;
                }

                foundTokenGlobal = foundToken; // Store for global use

                const now = new Date();
                const startTime = new Date(foundToken.startTime);
                const endTime = new Date(foundToken.endTime);
                let tokenStatus = '';

                if (foundToken.isForceActive === true) {
                    tokenStatus = 'valid';
                } else if (foundToken.isActive === true) {
                    if (now >= startTime && now <= endTime) {
                        tokenStatus = 'valid';
                    } else {
                        tokenStatus = 'expired';
                    }
                } else {
                    tokenStatus = 'inactive';
                }

                if (tokenStatus !== 'valid') {
                    message.style.color = "red";
                    if (tokenStatus === 'expired') {
                        message.textContent = "Token belum aktif atau sudah kadaluarsa.";
                    } else {
                        message.textContent = "Token saat ini tidak aktif.";
                    }
                    updateLoginButtonStatus();
                    return;
                }

                const studentClassNumericMatch = selectedStudentData.class.match(/^\d+/);
                const studentClassNumeric = studentClassNumericMatch ? studentClassNumericMatch[0] : null;

                if (!studentClassNumeric || String(studentClassNumeric) !== String(foundToken.kelas)) {
                    message.style.color = "red";
                    message.textContent = `Siswa dari kelas ${selectedStudentData.class} tidak dapat mengakses token untuk kelas ${foundToken.kelas}.`;
                    updateLoginButtonStatus();
                    return;
                }

                // Calculate exam duration in minutes
                const examDurationMs = endTime.getTime() - startTime.getTime();
                const examDurationMinutes = Math.round(examDurationMs / (1000 * 60));

                document.getElementById("modalIdSiswa").textContent = selectedStudentData.id || "-";
                document.getElementById("modalNamaLengkap").textContent = selectedStudentData.name || "-";
                document.getElementById("modalKelas").textContent = selectedStudentData.class || "-";
                document.getElementById("modalMapel").textContent = foundToken.subject || "-";
                modalExamDuration.textContent = `${examDurationMinutes} Menit`;

                confirmCheckbox.checked = false;
                modalMessage.style.display = 'none';
                modalMessage.textContent = '';


                confirmModal.classList.add('show');
                message.textContent = "";

                document.getElementById("btnLanjut").onclick = () => handleLanjutClick(fullInputToken, examDurationMinutes);

            } catch (err) {
                console.error(err);
                message.style.color = "red";
                message.textContent = "Terjadi kesalahan saat memverifikasi token. Silakan coba lagi atau hubungi administrator.";
                updateLoginButtonStatus();
            }
        };

        // --- Initial Setup when DOM Content is Loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // Event listener to prevent context menu (right-click/long-press)
            // This will be handled by toggleExamSecurityFeatures when isInExamMode
            document.addEventListener('contextmenu', function (e) {
                if (isInExamMode) { // Only active if in exam mode
                    e.preventDefault();
                }
            });

            // Event listener for custom dropdown displays
            customSelectKelasDisplay.addEventListener('click', openClassModal);
            customSelectNamaSiswaDisplay.addEventListener('click', openStudentModal);

            // Event listener to close custom modals when clicking outside their content
            classModal.addEventListener('click', (event) => {
                if (event.target === classModal) {
                    closeClassModal();
                }
            });
            studentModal.addEventListener('click', (event) => {
                if (event.target === studentModal) {
                    closeStudentModal();
                }
            });

            // Event listener for inputToken
            inputToken.addEventListener('input', () => window.formatToken(inputToken));
            inputToken.addEventListener('input', updateLoginButtonStatus);

            // NEW: Event listener for Enter key on inputToken
            inputToken.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !loginBtn.disabled) {
                    event.preventDefault(); // Prevent default form submission if any
                    cekToken();
                }
            });

            // Event listener for initial instruction overlay
            overlayUnderstandBtn.addEventListener('click', hideOverlay); // IMPORTANT: This will trigger fullscreen

            unlockButton.addEventListener('click', handleUnlockExam);
            
            // Event listener for the BACK button on the submission confirmation overlay
            backToLoginFromSubmissionBtn.addEventListener('click', () => {
                // Smooth transition out for submission overlay
                submissionConfirmationOverlay.style.opacity = 0;
                setTimeout(() => {
                    submissionConfirmationOverlay.style.display = 'none';
                    // Re-enable initial login view
                    loginContainer.style.display = 'flex';
                    loginContainer.style.opacity = 1;
                    document.body.style.overflow = '';
                    // Clean up any remaining fullscreen state
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    // Ensure security features are off
                    isInExamMode = false;
                    toggleExamSecurityFeatures(false);
                    // Clear message and reset selection
                    message.textContent = '';
                    hiddenSelectKelas.value = ''; // Reset hidden class value
                    customSelectKelasDisplay.textContent = customSelectKelasDisplay.dataset.placeholder;
                    customSelectKelasDisplay.classList.remove('selected');
                    filterStudentsByClass(); // Resets student selection and display
                    inputToken.value = '';
                    inputToken.classList.remove('is-valid', 'is-invalid');
                    updateLoginButtonStatus(); // Recalculate button status
                    sessionStorage.clear(); // Clear session storage when returning to login
                }, 300); // Match CSS transition duration
            });

            // IMPORTANT: Event listener to prevent browser back button
            window.onpopstate = function(event) {
                if (isInExamMode) { // Only applies if in exam mode
                    history.pushState(null, '', location.href);
                    console.log("Back navigation prevented during exam.");
                }
            };

            // NEW: Event listener for fullscreen status changes
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange); /* Firefox */
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange); /* Chrome, Safari and Opera */
            document.addEventListener('msfullscreenchange', handleFullscreenChange); /* IE/Edge */

            // NEW: Event listener for the re-enter fullscreen button on the warning overlay
            reEnterFullscreenBtn.addEventListener('click', attemptFullscreen);

            // NEW: Event listeners for refresh button and warning overlay
            refreshPageBtn.addEventListener('click', showRefreshWarningOverlay);
            continueRefreshBtn.addEventListener('click', () => {
                hideRefreshWarningOverlay();
                location.reload(); // Perform the actual refresh
            });
            cancelRefreshBtn.addEventListener('click', hideRefreshWarningOverlay);

            // NEW: Browser's native warning for refresh/closing tab (pull-to-refresh)
            window.onbeforeunload = function() {
                if (isInExamMode) {
                    // This message will be displayed in the browser's native confirmation dialog.
                    // Custom messages might be ignored by some browsers for security reasons.
                    return "Jawaban Anda yang belum tersimpan mungkin akan hilang jika Anda merefresh halaman. Lanjutkan?";
                }
                // Return undefined or nothing if no warning is needed
            };


            updateDateTime();
            setInterval(updateDateTime, 1000);

            loadSettingsAndStudents();
            loginContainer.style.opacity = 1; // Ensure login container is visible initially
            updateLoginButtonStatus(); // Initial call to set correct disabled state
        });

        /**
         * Loads Firebase settings (location enabled, radius) and then student data.
         * Starts location check after data is loaded.
         * @returns {Promise<void>}
         */
        async function loadSettingsAndStudents() {
            locationStatus.style.display = 'block';
            locationStatus.textContent = 'Memuat status lokasi dan data siswa...';

            try {
                const settingsSnapshot = await get(settingsRef);
                if (settingsSnapshot.exists()) {
                    const settings = settingsSnapshot.val();
                    isLocationEnabled = settings.isLocationEnabled !== undefined ? settings.isLocationEnabled : true;
                    firebaseAllowedRadiusKm = settings.allowedRadiusKm !== undefined ? settings.allowedRadiusKm : 0.075;
                    console.log("Location Status from Firebase:", isLocationEnabled);
                    console.log("Radius from Firebase:", firebaseAllowedRadiusKm);
                } else {
                    console.log("Tidak dapat mengambil pengaturan lokasi dari Firebase, menggunakan default.");
                }

                const adminSettingsSnapshot = await get(adminSettingsRef);
                if (adminSettingsSnapshot.exists()) {
                    const adminSettings = adminSettingsSnapshot.val();
                    examUnlockPassword = adminSettings.examUnlockPassword || '';
                    console.log("Exam Unlock Password loaded:", examUnlockPassword ? 'Loaded' : 'Not set');
                } else {
                    console.log("Could not retrieve admin settings from Firebase, unlock password not set.");
                }

            } catch (error) {
                console.error("Gagal mengambil pengaturan lokasi atau admin dari Firebase:", error);
            }

            await loadStudentsAndPopulateClassDropdown();
            locationStatus.textContent = '';
            restoreExamState(); // Call to restore exam state after all data is loaded
        }

        // NEW: Functions for Refresh Warning Overlay
        function showRefreshWarningOverlay() {
            refreshWarningOverlay.style.display = 'flex';
            setTimeout(() => { refreshWarningOverlay.style.opacity = 1; }, 10);
            document.body.style.overflow = 'hidden'; // Prevent scrolling behind overlay
        }

        function hideRefreshWarningOverlay() {
            refreshWarningOverlay.style.opacity = 0;
            setTimeout(() => {
                refreshWarningOverlay.style.display = 'none';
                document.body.style.overflow = ''; // Restore scrolling
            }, 300);
        }
    </script>
</body>
</html>
